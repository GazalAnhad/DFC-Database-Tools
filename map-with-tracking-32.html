<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Country Map - Research Database</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="https://unpkg.com/topojson@3"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background: #aad3df;
        }
        #map-container {
            width: 100%;
            height: 100vh;
            position: relative;
            background: #aad3df;
        }
        svg {
            width: 100%;
            height: 100%;
            background: #aad3df;
        }
        .country {
            fill: #f2efe9;
            stroke: #ccc;
            stroke-width: 0.5;
        }
        .legend {
            position: absolute;
            bottom: 50px;
            right: 20px;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            font-size: 12px;
            max-width: 250px;
            transition: all 0.3s;
        }
        .legend.collapsed {
            padding: 10px;
        }
        .legend.collapsed .legend-content {
            display: none;
        }
        .legend-toggle {
            cursor: pointer;
            font-weight: bold;
            color: #2c3e50;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .legend-toggle:hover {
            color: #3498db;
        }
        .legend-content {
            margin-top: 10px;
        }
        .legend-section {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #ddd;
        }
        .legend-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .legend-item {
            margin: 3px 0;
        }
        .legend-color {
            display: inline-block;
            width: 12px;
            height: 12px;
            margin-right: 5px;
            border: 1px solid #333;
            border-radius: 50%;
        }
        .status {
            position: absolute;
            top: 80px;
            left: 10px;
            background: white;
            padding: 10px 15px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 1000;
            font-size: 12px;
            min-width: 200px;
        }
        .status-item {
            margin: 5px 0;
            padding: 3px 0;
        }
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 2000;
            text-align: center;
        }
        .spinner {
            border: 3px solid #D4D6F2;
            border-top: 3px solid #9398DC;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 10px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1001;
            max-width: 250px;
        }
        .tooltip-country {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 13px;
        }
        .tooltip-topics {
            font-size: 11px;
            color: #ddd;
            margin-top: 3px;
        }
        .continent-label {
            font-size: 11px;
            fill: #555;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 2px;
            opacity: 0.6;
            pointer-events: none;
        }
        .attribution {
            position: absolute;
            bottom: 5px;
            left: 10px;
            font-size: 10px;
            color: #333;
            z-index: 1000;
            max-width: 600px;
            line-height: 1.4;
            background: rgba(255, 255, 255, 0.9);
            padding: 8px 12px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .attribution a {
            color: #3498db;
            text-decoration: none;
        }
        .attribution a:hover {
            text-decoration: underline;
        }
        .credit {
            position: absolute;
            bottom: 10px;
            right: 10px;
            font-size: 11px;
            color: #6b7280;
            font-style: italic;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            padding: 8px 12px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .credit a {
            color: #9398DC;
            text-decoration: none;
        }
        .credit a:hover {
            text-decoration: underline;
        }
        .map-title {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 18px;
            font-weight: 600;
            color: #374151;
            z-index: 1000;
            background: transparent;
            padding: 10px 20px;
            border-radius: 5px;
            transition: background 0.3s ease;
        }
        .map-title.zoomed {
            background: rgba(255, 255, 255, 0.7);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div id="loading" class="loading">
        <div class="spinner"></div>
        <div>Loading map data...</div>
    </div>
    <div class="map-title">DFC Global Research Database Interactive Map of Resources</div>
    <div id="status" class="status" style="display: none;"></div>
    <div id="map-container"></div>
    
    <div class="legend" id="legend">
        <div class="legend-toggle" onclick="toggleLegend()">
            <span>Legend</span>
            <span id="legend-arrow">▲</span>
        </div>
        <div class="legend-content">
            <div class="legend-section">
                <strong>UN M49 Regions</strong>
                <div class="legend-item"><span class="legend-color" style="background: #f39c12;"></span>Africa</div>
                <div class="legend-item"><span class="legend-color" style="background: #27ae60;"></span>Americas</div>
                <div class="legend-item"><span class="legend-color" style="background: #e74c3c;"></span>Asia</div>
                <div class="legend-item"><span class="legend-color" style="background: #3498db;"></span>Europe</div>
                <div class="legend-item"><span class="legend-color" style="background: #95a5a6;"></span>Global/Regional</div>
                <div class="legend-item"><span class="legend-color" style="background: #9b59b6;"></span>Oceania</div>
            </div>
            <div class="legend-section">
                <strong>Marker Size</strong>
                <div class="legend-item"><span class="legend-color" style="background: #333; width: 4px; height: 4px;"></span>1-3 entries</div>
                <div class="legend-item"><span class="legend-color" style="background: #333; width: 5.5px; height: 5.5px;"></span>4-8 entries</div>
                <div class="legend-item"><span class="legend-color" style="background: #333; width: 7px; height: 7px;"></span>9-15 entries</div>
                <div class="legend-item"><span class="legend-color" style="background: #333; width: 10px; height: 10px;"></span>16-25 entries</div>
                <div class="legend-item"><span class="legend-color" style="background: #333; width: 13px; height: 13px;"></span>26+ entries</div>
            </div>
        </div>
    </div>

    <div class="attribution">
        This map uses the <a href="https://en.wikipedia.org/wiki/Equal_Earth_projection" target="_blank">Equal Earth projection</a> with regional classifications based on the <a href="https://unstats.un.org/unsd/methodology/m49/" target="_blank">UN M49 geoscheme</a>. Data from the <a href="https://www.zotero.org/about/" target="_blank">Zotero API</a>.
    </div>
    
    <div class="credit">
        This live map was created by <a href="https://www.gazalatwork.com" target="_blank" rel="noopener noreferrer">Gazal Shekhawat</a> for the <a href="https://www.digital-futures-for-children.net/home" target="_blank" rel="noopener noreferrer">DFC</a>
    </div>

    <script>
        const WORKER_URL = 'https://topic-map.gazal-a-shekhawat.workers.dev';
        
        // Initialize tracking on page load
        async function initializeTracking() {
            try {
                const mapViewResult = await window.storage.get('map-views', true);
                const currentMapViews = mapViewResult ? parseInt(mapViewResult.value) : 0;
                const newMapViews = currentMapViews + 1;
                await window.storage.set('map-views', newMapViews.toString(), true);
                console.log('Map views:', newMapViews);

                const zoteroResult = await window.storage.get('zotero-clicks', true);
                const zoteroClicks = zoteroResult ? parseInt(zoteroResult.value) : 0;
                console.log('Zotero clicks:', zoteroClicks);
            } catch (error) {
                console.error('Error initializing tracking:', error);
            }
        }

        async function trackZoteroClick() {
            try {
                const result = await window.storage.get('zotero-clicks', true);
                const currentClicks = result ? parseInt(result.value) : 0;
                const newClicks = currentClicks + 1;
                await window.storage.set('zotero-clicks', newClicks.toString(), true);
                console.log('Zotero clicks:', newClicks);
            } catch (error) {
                console.error('Error tracking Zotero click:', error);
            }
        }

        function toggleLegend() {
            const legend = document.getElementById('legend');
            const arrow = document.getElementById('legend-arrow');
            legend.classList.toggle('collapsed');
            arrow.textContent = legend.classList.contains('collapsed') ? '▼' : '▲';
        }

        const continentLabels = [
            {name: 'AFRICA', lon: 3, lat: -3, type: 'continent'},
            {name: 'AMERICAS', lon: -130, lat: 20, type: 'continent'},
            {name: 'ASIA', lon: 90, lat: 47, type: 'continent'},
            {name: 'EUROPE', lon: -15, lat: 45, type: 'continent'},
            {name: 'OCEANIA', lon: -165, lat: -40, type: 'continent'}
        ];

        const regionMapping = {
            'Australia': 'Oceania', 'New Zealand': 'Oceania', 'Fiji': 'Oceania', 'Samoa': 'Oceania',
            'United States': 'Americas', 'Canada': 'Americas', 'Mexico': 'Americas', 'Brazil': 'Americas',
            'Argentina': 'Americas', 'Chile': 'Americas', 'Peru': 'Americas', 'Colombia': 'Americas',
            'Uruguay': 'Americas', 'Ecuador': 'Americas', 'Costa Rica': 'Americas', 'Jamaica': 'Americas',
            'Cuba': 'Americas', 'Guatemala': 'Americas', 'Antigua & Barbuda': 'Americas',
            'China': 'Asia', 'India': 'Asia', 'Japan': 'Asia', 'South Korea': 'Asia',
            'Indonesia': 'Asia', 'Thailand': 'Asia', 'Malaysia': 'Asia', 'Singapore': 'Asia',
            'Philippines': 'Asia', 'The Philippines': 'Asia', 'Vietnam': 'Asia', 'Cambodia': 'Asia',
            'Nepal': 'Asia', 'Mongolia': 'Asia', 'Bangladesh': 'Asia', 'Pakistan': 'Asia',
            'Afghanistan': 'Asia', 'Iran': 'Asia', 'Iraq': 'Asia', 'Saudi Arabia': 'Asia',
            'United Arab Emirates': 'Asia', 'Kuwait': 'Asia', 'Lebanon': 'Asia', 'Jordan': 'Asia',
            'Syria': 'Asia', 'Yemen': 'Asia', 'Israel': 'Asia', 'Palestine': 'Asia',
            'Turkey': 'Asia', 'Kazakhstan': 'Asia', 'Kyrgyzstan': 'Asia', 'Azerbaijan': 'Asia',
            'United Kingdom': 'Europe', 'Germany': 'Europe', 'France': 'Europe', 'Italy': 'Europe',
            'Spain': 'Europe', 'Netherlands': 'Europe', 'Sweden': 'Europe', 'Switzerland': 'Europe',
            'Belgium': 'Europe', 'Poland': 'Europe', 'Norway': 'Europe', 'Finland': 'Europe',
            'Portugal': 'Europe', 'Austria': 'Europe', 'Greece': 'Europe', 'Czech Republic': 'Europe',
            'Romania': 'Europe', 'Hungary': 'Europe', 'Denmark': 'Europe', 'Ireland': 'Europe',
            'Estonia': 'Europe', 'Slovenia': 'Europe', 'Croatia': 'Europe', 'Lithuania': 'Europe',
            'Slovakia': 'Europe', 'Serbia': 'Europe', 'Malta': 'Europe', 'Russia': 'Europe',
            'South Africa': 'Africa', 'Egypt': 'Africa', 'Nigeria': 'Africa', 'Kenya': 'Africa',
            'Ghana': 'Africa', 'Uganda': 'Africa', 'Tanzania': 'Africa', 'Ethiopia': 'Africa',
            'Morocco': 'Africa', 'Algeria': 'Africa', 'Tunisia': 'Africa', 'Zimbabwe': 'Africa',
            'Zambia': 'Africa', 'Mozambique': 'Africa', 'Namibia': 'Africa', 'Botswana': 'Africa',
            'Mauritius': 'Africa', 'Libya': 'Africa', 'Sudan': 'Africa', 'Congo': 'Africa',
            'Benin': 'Africa', 'Burkina Faso': 'Africa', 'Cameroon': 'Africa', 'Mauritania': 'Africa',
            'OECD': 'Global', 'global': 'Global', 'Global': 'Global',
            'European Union': 'Global', 'WHO Member States': 'Global'
        };

        const continentColors = {
            'Europe': '#3498db',
            'Asia': '#e74c3c',
            'Africa': '#f39c12',
            'Americas': '#27ae60',
            'Oceania': '#9b59b6',
            'Global': '#95a5a6'
        };

        const countryCoordinates = {
            'Afghanistan': [67.7100, 33.9391], 'Albania': [20.1683, 41.1533], 'Algeria': [1.6596, 28.0339],
            'Andorra': [1.6010, 42.5063], 'Angola': [17.8739, -11.2027], 'Antigua & Barbuda': [-61.8456, 17.0747],
            'Antigua and Barbuda': [-61.8456, 17.0747], 'Argentina': [-63.6167, -38.4161], 'Armenia': [45.0382, 40.0691],
            'Australia': [133.7751, -25.2744], 'Austria': [14.5501, 47.5162], 'Azerbaijan': [47.5769, 40.1431],
            'Bahamas': [-77.3963, 25.0343], 'Bahrain': [50.5577, 26.0667], 'Bangladesh': [90.3563, 23.6850],
            'Barbados': [-59.5432, 13.1939], 'Belarus': [27.9534, 53.7098], 'Belgium': [4.4699, 50.5039],
            'Belize': [-88.4976, 17.1899], 'Benin': [2.3158, 9.3077], 'Bhutan': [90.4336, 27.5142],
            'Bolivia': [-63.5887, -16.2902], 'Bosnia and Herzegovina': [17.6791, 43.9159], 'Botswana': [24.6849, -22.3285],
            'Brazil': [-52, -12], 'Brunei': [114.7277, 4.5353], 'Bulgaria': [25.4858, 42.7339],
            'Burkina Faso': [-1.5616, 12.2383], 'Burundi': [29.9189, -3.3731], 'Cambodia': [104.9910, 12.5657],
            'Cameroon': [12.3547, 7.3697], 'Canada': [-106.3468, 56.1304], 'Cape Verde': [-24.0132, 16.5388],
            'Central African Republic': [20.9394, 6.6111], 'Chad': [18.7322, 15.4542], 'Chile': [-70, -32],
            'China': [104.1954, 35.8617], 'Colombia': [-73, 3.5], 'Comoros': [43.8722, -11.6455],
            'Congo': [21.7587, -4.0383], 'DR Congo': [21.7587, -2.8770], 'Costa Rica': [-83.7534, 9.7489],
            'Croatia': [15.2, 45.1], 'Cuba': [-77.7812, 21.5218], 'Cyprus': [33.4299, 35.1264],
            'Czech Republic': [15.4730, 49.8175], 'Denmark': [9.5018, 56.2639], 'Djibouti': [42.5903, 11.8251],
            'Dominica': [-61.3710, 15.4150], 'Dominican Republic': [-70.1627, 18.7357], 'Ecuador': [-78.1834, -1.8312],
            'Egypt': [30.8025, 26.8206], 'El Salvador': [-88.8965, 13.7942], 'Equatorial Guinea': [10.2679, 1.6508],
            'Eritrea': [39.7823, 15.1794], 'Estonia': [25.0136, 58.5953], 'Eswatini': [31.4659, -26.5225],
            'Ethiopia': [40.4897, 9.1450], 'Fiji': [179.4144, -17.7134], 'Finland': [25.7482, 61.9241],
            'France': [2.2137, 46.2276], 'Gabon': [11.6094, -0.8037], 'Gambia': [-15.3101, 13.4432],
            'Georgia': [43.3569, 42.3154], 'Germany': [10.4515, 51.1657], 'Ghana': [-1.0232, 7.9465],
            'Greece': [21.8243, 39.0742], 'Grenada': [-61.6790, 12.1165], 'Guatemala': [-90.2308, 15.7835],
            'Guinea': [-9.6966, 9.9456], 'Guinea-Bissau': [-15.1804, 11.8037], 'Guyana': [-58.9302, 4.8604],
            'Haiti': [-72.2852, 18.9712], 'Honduras': [-86.2419, 15.2000], 'Hungary': [19.5033, 47.1625],
            'Iceland': [-19.0208, 64.9631], 'India': [78.9629, 20.5937], 'Indonesia': [113.9213, -0.7893],
            'Iran': [53.6880, 32.4279], 'Iraq': [43.6793, 33.2232], 'Ireland': [-8.2439, 53.4129],
            'Israel': [34.8516, 31.0461], 'Italy': [12.5674, 41.8719], 'Jamaica': [-77.2975, 18.1096],
            'Japan': [138.2529, 36.2048], 'Jordan': [36.2384, 30.5852], 'Kazakhstan': [66.9237, 48.0196],
            'Kenya': [37.9062, -0.0236], 'Kiribati': [-168.7340, 1.8709], 'North Korea': [127.5101, 40.3399],
            'South Korea': [127.7669, 35.9078], 'Kosovo': [20.9021, 42.6026], 'Kuwait': [47.4818, 29.3117],
            'Kyrgyzstan': [74.7661, 41.2044], 'Laos': [102.4955, 19.8563], 'Latvia': [24.6032, 56.8796],
            'Lebanon': [35.8623, 33.8547], 'Lesotho': [28.2336, -29.6100], 'Liberia': [-9.4295, 6.4281],
            'Libya': [17.2283, 26.3351], 'Liechtenstein': [9.5554, 47.1660], 'Lithuania': [23.8813, 55.1694],
            'Luxembourg': [6.1296, 49.8153], 'Madagascar': [46.8691, -18.7669], 'Malawi': [34.3015, -13.2543],
            'Malaysia': [101.9758, 4.2105], 'Maldives': [73.2207, 3.2028], 'Mali': [-3.9962, 17.5707],
            'Malta': [14.3754, 35.9375], 'Marshall Islands': [171.1845, 7.1315], 'Mauritania': [-10.9408, 21.0079],
            'Mauritius': [57.5522, -20.3484], 'Mexico': [-102.5528, 23.6345], 'Micronesia': [158.2150, 7.4256],
            'Moldova': [28.3699, 47.4116], 'Monaco': [7.4246, 43.7384], 'Mongolia': [103.8467, 46.8625],
            'Montenegro': [19.3744, 42.7087], 'Morocco': [-7.0926, 31.7917], 'Mozambique': [35.5296, -18.6657],
            'Myanmar': [95.9560, 21.9162], 'Namibia': [18.4904, -22.9576], 'Nauru': [166.9315, -0.5228],
            'Nepal': [84.1240, 28.3949], 'Netherlands': [5.2913, 52.1326], 'New Zealand': [174.8860, -40.9006],
            'Nicaragua': [-85.2072, 12.8654], 'Niger': [8.0817, 17.6078], 'Nigeria': [8.6753, 9.0820],
            'North Macedonia': [21.7453, 41.6086], 'Norway': [8.4689, 60.4720], 'Oman': [55.9233, 21.4735],
            'Pakistan': [69.3451, 30.3753], 'Palau': [134.5825, 7.5150], 'Palestine': [35.2332, 31.9522],
            'Panama': [-80.7821, 8.5380], 'Papua New Guinea': [143.9555, -6.3150], 'Paraguay': [-58.4438, -23.4425],
            'Peru': [-75.0152, -9.1900], 'Philippines': [121.7740, 12.8797], 'The Philippines': [121.7740, 12.8797],
            'Poland': [19.1451, 51.9194], 'Portugal': [-8.2245, 39.3999], 'Qatar': [51.1839, 25.3548],
            'Romania': [24.9668, 45.9432], 'Russia': [105.3188, 61.5240], 'Rwanda': [29.8739, -1.9403],
            'Saint Kitts and Nevis': [-62.7830, 17.3578], 'Saint Lucia': [-60.9789, 13.9094],
            'Saint Vincent and the Grenadines': [-61.2872, 12.9843], 'Samoa': [-172.1046, -13.7590],
            'San Marino': [12.4578, 43.9424], 'São Tomé and Príncipe': [6.6131, 0.1864],
            'Saudi Arabia': [45.0792, 23.8859], 'Senegal': [-14.4524, 14.4974], 'Serbia': [21.0059, 44.0165],
            'Seychelles': [55.4920, -4.6796], 'Sierra Leone': [-11.7799, 8.4606], 'Singapore': [103.8198, 1.3521],
            'Slovakia': [19.6990, 48.6690], 'Slovenia': [14.9955, 46.1512], 'Solomon Islands': [160.1562, -9.6457],
            'Somalia': [46.1996, 5.1521], 'South Africa': [22.9375, -30.5595], 'South Sudan': [31.3070, 6.8770],
            'Spain': [-3.7492, 40.4637], 'Sri Lanka': [80.7718, 7.8731], 'Sudan': [30.2176, 12.8628],
            'Suriname': [-56.0278, 3.9193], 'Sweden': [18.6435, 60.1282], 'Switzerland': [8.2275, 46.8182],
            'Syria': [38.9968, 34.8021], 'Taiwan': [120.9605, 23.6978], 'Tajikistan': [71.2761, 38.8610],
            'Tanzania': [34.8888, -6.3690], 'Thailand': [100.9925, 15.8700], 'Timor-Leste': [125.7275, -8.8742],
            'Togo': [0.8248, 8.6195], 'Tonga': [-175.1982, -21.1789], 'Trinidad and Tobago': [-61.2225, 10.6918],
            'Tunisia': [9.5375, 33.8869], 'Turkey': [35.2433, 38.9637], 'Turkmenistan': [59.5563, 38.9697],
            'Tuvalu': [179.1962, -7.1095], 'Uganda': [32.2903, 1.3733], 'Ukraine': [31.1656, 48.3794],
            'United Arab Emirates': [53.8478, 23.4241], 'United Kingdom': [-3.4360, 55.3781],
            'United States': [-95.7129, 37.0902], 'Uruguay': [-56, -33], 'Uzbekistan': [64.5853, 41.3775],
            'Vanuatu': [166.9592, -15.3767], 'Vatican City': [12.4534, 41.9029], 'Venezuela': [-66.5897, 6.4238],
            'Vietnam': [108.2772, 14.0583], 'Yemen': [48.5164, 15.5527], 'Zambia': [27.8493, -13.1339],
            'Zimbabwe': [29.1549, -19.0154], 'OECD': [-35, 30], 'global': [-35, 20],
            'Global': [-35, 20], 'European Union': [-35, 40], 'WHO Member States': [-35, 10]
        };

        async function loadData() {
            try {
                console.time('Total Load Time');
                console.time('Fetch Worker Data');
                
                const response = await fetch(WORKER_URL);
                console.timeEnd('Fetch Worker Data');
                
                if (!response.ok) throw new Error('Failed to fetch data');
                
                console.time('Parse JSON');
                const data = await response.json();
                console.timeEnd('Parse JSON');
                
                if (data.error) throw new Error(data.error);
                
                console.log('Data received:', {
                    countries: Object.keys(data.countries).length,
                    timestamp: data.timestamp
                });
                
                console.time('Convert Data');
                const countriesData = {};
                Object.keys(data.countries).forEach(country => {
                    countriesData[country] = data.countries[country].count;
                });
                console.timeEnd('Convert Data');
                
                console.time('Render Map');
                renderMap(countriesData, data.countries);
                console.timeEnd('Render Map');
                
                console.timeEnd('Total Load Time');
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loading').innerHTML = 
                    '<div style="color: #dc2626;">Error: ' + error.message + '</div>';
            }
        }

        function renderMap(countriesData, fullData) {
            const width = window.innerWidth;
            const height = window.innerHeight;
            
            const projection = d3.geoEqualEarth()
                .scale(width / 6)
                .translate([width / 2, height / 2]);

            const path = d3.geoPath().projection(projection);

            const zoom = d3.zoom()
                .scaleExtent([1, 8])
                .on('zoom', (event) => {
                    g.attr('transform', event.transform);
                    
                    const titleEl = document.querySelector('.map-title');
                    if (titleEl && event.transform.k > 1.2) {
                        titleEl.classList.add('zoomed');
                    } else if (titleEl) {
                        titleEl.classList.remove('zoomed');
                    }
                });

            const svg = d3.select('#map-container')
                .append('svg')
                .attr('width', width)
                .attr('height', height)
                .call(zoom);

            const g = svg.append('g');

            const tooltip = d3.select('body').append('div')
                .attr('class', 'tooltip')
                .style('display', 'none');

            d3.json('https://cdn.jsdelivr.net/npm/world-atlas@2/countries-50m.json').then(world => {
                const countries = topojson.feature(world, world.objects.countries);

                g.selectAll('path')
                    .data(countries.features)
                    .enter()
                    .append('path')
                    .attr('class', 'country')
                    .attr('d', path)
                    .style('pointer-events', 'none');

                continentLabels.forEach(label => {
                    const coords = projection([label.lon, label.lat]);
                    if (coords) {
                        g.append('text')
                            .attr('class', 'continent-label')
                            .attr('x', coords[0])
                            .attr('y', coords[1])
                            .attr('text-anchor', 'middle')
                            .text(label.name);
                    }
                });

                const counts = Object.values(countriesData);
                const maxCount = Math.max(...counts);
                const minCount = Math.min(...counts);
                const countryCount = Object.keys(countriesData).length;

                Object.keys(countriesData).forEach(country => {
                    const count = countriesData[country];
                    const coords = countryCoordinates[country];
                    
                    if (coords) {
                        const [lon, lat] = coords;
                        const point = projection([lon, lat]);
                        
                        if (point) {
                            let size = 4;
                            if (count >= 26) size = 13;
                            else if (count >= 16) size = 10;
                            else if (count >= 9) size = 7;
                            else if (count >= 4) size = 5.5;
                            else size = 4;

                            const region = regionMapping[country] || 'Global';
                            const color = continentColors[region] || '#95a5a6';
                            
                            const zoteroLink = `https://www.zotero.org/groups/5501205/digitalfuturesforchildren/tags/Country:%20${encodeURIComponent(country)}/library`;
                            
                            const topics = fullData[country] && fullData[country].topics ? fullData[country].topics : [];
                            const topicsText = topics.length > 0 ? topics.slice(0, 5).join(', ') + (topics.length > 5 ? '...' : '') : 'No topics';
                            
                            g.append('circle')
                                .attr('cx', point[0])
                                .attr('cy', point[1])
                                .attr('r', size)
                                .attr('fill', color)
                                .attr('fill-opacity', 0.8)
                                .attr('stroke', 'white')
                                .attr('stroke-width', 1)
                                .style('cursor', 'pointer')
                                .style('pointer-events', 'all')
                                .on('mouseover', function() {
                                    d3.select(this)
                                        .attr('r', size * 1.5)
                                        .attr('fill-opacity', 1);
                                    tooltip
                                        .style('display', 'block')
                                        .html(
                                            '<div class="tooltip-country">' + country + '</div>' +
                                            '<div>' + count + ' ' + (count === 1 ? 'entry' : 'entries') + '</div>' +
                                            '<div class="tooltip-topics">Topics: ' + topicsText + '</div>'
                                        );
                                })
                                .on('mousemove', function(event) {
                                    tooltip
                                        .style('left', (event.pageX + 10) + 'px')
                                        .style('top', (event.pageY - 28) + 'px');
                                })
                                .on('mouseout', function() {
                                    d3.select(this)
                                        .attr('r', size)
                                        .attr('fill-opacity', 0.8);
                                    tooltip.style('display', 'none');
                                })
                                .on('click', function() {
                                    trackZoteroClick();
                                    window.open(zoteroLink, '_blank');
                                });
                        }
                    }
                });

                document.getElementById('loading').style.display = 'none';
                
                const statusDiv = document.getElementById('status');
                if (statusDiv) {
                    statusDiv.style.display = 'block';
                    statusDiv.innerHTML = 
                        '<div class="status-item"><strong>' + countryCount + ' countries</strong></div>' +
                        '<div class="status-item">Range: ' + minCount + '-' + maxCount + '</div>';
                }
            });
        }

        window.addEventListener('resize', function() {
            d3.select('#map-container svg').remove();
            loadData();
        });

        initializeTracking().then(() => {
            loadData();
        });
    </script>
</body>
</html>